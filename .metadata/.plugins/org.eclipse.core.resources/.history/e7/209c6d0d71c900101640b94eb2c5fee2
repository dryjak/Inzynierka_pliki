/*
 * state_mashine.c
 *
 *  Created on: Nov 24, 2025
 *      Author: dryla
 */

#include <main.h>
#include <state_mashine.h>

//Init Function
void Button_Init(Button_t *Button, GPIO_TypeDef *GpioPort, uint16_t GpioPin, uint32_t TimerDebounce)
{
	Button->GpioPort = GpioPort;
	Button->GpioPin = GpioPin;

	Button->TimerDebounce = TimerDebounce;

	Button->State = IDLE;
}
//register callbacks
void Button_RegisterPressCallback(Button_t *Button, void (*Callback)(void))
{
	Button->ButtonPressed = Callback;
}

//State Idle
void Button_IdleState(Button_t *Button)
{
	if(HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin) == GPIO_PIN_SET)
	{
		Button->State = DEBOUNCE;
		Button->LastTick = HAL_GetTick();
	}
}

//State Debounce
void Button_Debounce(Button_t *Button)
{
	if((HAL_GetTick() - Button->LastTick) >= Button->TimerDebounce)
	{

		if (HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin) == GPIO_PIN_SET)
		{
			Button->State = PRESSED;

			if(Button->ButtonPressed != NULL)
			{
				Button->ButtonPressed();
			}
		}
		else //Button released
		{
			Button->State = IDLE;
		}
	}
}

//State Pressed
void Button_Pressed(Button_t *Button)
{
	if (HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin) == GPIO_PIN_RESET)
	{
		Button->State = IDLE;
	}
}

void ButtonTasks(Button_t *Button)
{
	switch(Button->State)
	{
		case IDLE:
			Button_IdleState(Button);
			break;
		case DEBOUNCE:
			Button_Debounce(Button);
			break;
		case PRESSED:
			Button_Pressed(Button);
			break;
		default:
			break;
	}

}

