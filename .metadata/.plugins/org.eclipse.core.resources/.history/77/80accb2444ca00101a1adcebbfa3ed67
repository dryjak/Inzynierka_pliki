/*
 * state_mashine.c
 *
 *  Created on: Nov 24, 2025
 *      Author: dryla
 */

#include <main.h>
#include <state_mashine.h>

static void Button_IdleState(Button_t *Button);
static void Button_Debounce(Button_t *Button);
static void Button_Pressed(Button_t *Button);
static void Button_Repeat(Button_t *Button);


//Init Function
void Button_Init(Button_t *Button, GPIO_TypeDef *GpioPort, uint16_t GpioPin, uint32_t TimerDebounce)
{
	Button->State = IDLE;

	Button->GpioPort = GpioPort;
	Button->GpioPin = GpioPin;

	Button->TimerDebounce = TimerDebounce;
}
//register callbacks
void Button_RegisterPressCallback(Button_t *Button, void(*Callback)())
{
	Button->ButtonPressed = Callback;
}

void ButtonTasks(Button_t *Button)
{
	switch(Button->State)
	{
		case IDLE:
			Button_IdleState(Button);
			break;
		case DEBOUNCE:
			Button_Debounce(Button);
			break;
		case PRESSED:
			Button_Pressed(Button);
			break;
		case REPEAT:
			Button_Repeat(Button);
			break;
		default:
			break;
	}
}

//State Idle
static void Button_IdleState(Button_t *Button)
{
	if(HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin) == GPIO_PIN_SET)
	{
		Button->State = DEBOUNCE;
		Button->LastTick = HAL_GetTick();
	}
}
void Button_SetDebounceTimer(Button_t *Button, uint32_t Milliseconds)
{
	Button->TimerDebounce = Milliseconds;
}
//State Debounce
static void Button_Debounce(Button_t *Button)
{
	if((HAL_GetTick() - Button->LastTick) > Button->TimerDebounce)
	{

		if (GPIO_PIN_SET == (HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin)))
		{
			Button->State = PRESSED;

			if(Button->ButtonPressed != NULL)
			{
				Button->ButtonPressed();
				Button->LastTick = HAL_GetTick();
			}
		}
		else //Button released
		{
			Button->State = IDLE;
		}
	}
}

//State Pressed
static void Button_Pressed(Button_t *Button)
{
	if (GPIO_PIN_RESET == HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin))
	{
		Button->State = IDLE;
	}
	else if (HAL_GetTick() - Button->LastTick >= 0)
	{
		Button->State = REPEAT;
		if (Button->ButtonLongPress != NULL)
		{
			Button->LastTick = HAL_GetTick();
			Button->ButtonLongPress();
		}
	}
}

static void Button_Repeat(Button_t *Button)
{
	if (GPIO_PIN_RESET == HAL_GPIO_ReadPin(B1_GPIO_Port, B1_Pin))
	{
		Button->State = IDLE;
	}
	else if (HAL_GetTick() - Button->LastTick >= 0)
	{
		//Repeat
		if(Button->ButtonRepeat != NULL)
		{
			Button->ButtonRepeat();
		}

		Button->LastTick = HAL_GetTick();
	}
}



