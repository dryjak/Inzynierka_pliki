/*
 * state_mashine.c
 *
 *  Created on: Nov 24, 2025
 *      Author: dryla
 */

#include <main.h>
#include <button.h>

static void Button_IdleState(Button_t *Button);
static void Button_Debounce(Button_t *Button);
static void Button_Pressed(Button_t *Button);
static void Button_Repeat(Button_t *Button);
static void Button_Release(Button_t *Button);



//Init Function
void Button_Init(Button_t *Button, GPIO_TypeDef *GpioPort, uint16_t GpioPin, uint32_t TimerDebounce, uint32_t TimerRepeat,
		uint32_t TimerLongPress)
{
	Button->State = IDLE;

	Button->GpioPort = GpioPort;
	Button->GpioPin = GpioPin;

	Button->ButtonPressed = NULL;
	Button->ButtonLongPress = NULL;
	Button->ButtonRepeat = NULL;

	Button->TimerDebounce = TimerDebounce;
	Button->TimerLongPress = TimerLongPress;
	Button->TimerRepeat = TimerRepeat;
}
//register callbacks
void Button_RegisterPressCallback(Button_t *Button, void(*Callback)())
{
	Button->ButtonPressed = Callback;
}
void Button_RegisterLongPressCallback(Button_t *Button, void(*Callback)())
{
	Button->ButtonLongPress = Callback;
}
void Button_RegisterRepeatCallback(Button_t *Button, void(*Callback)())
{
	Button->ButtonRepeat = Callback;
}
void Button_RegisterReleaseCallback(Button_t *Button, void(*Callback)())
{
	Button->ButtonRelease = Callback;
}

void ButtonTasks(Button_t *Button)
{
	switch(Button->State)
	{
		case IDLE:
			Button_IdleState(Button);
			break;
		case DEBOUNCE:
			Button_Debounce(Button);
			break;
		case PRESSED:
			Button_Pressed(Button);
			break;
		case REPEAT:
			Button_Repeat(Button);
			break;
		case RELEASE:
			Button_Release(Button);
			break;
		default:
			break;
	}
}

//State Idle
static void Button_IdleState(Button_t *Button)
{
	if(HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin) == GPIO_PIN_SET)
	{
		Button->State = DEBOUNCE;
		Button->LastTick = HAL_GetTick();
	}
}
//State Debounce
static void Button_Debounce(Button_t *Button)
{
	if((HAL_GetTick() - Button->LastTick) > Button->TimerDebounce)
	{

		if (GPIO_PIN_SET == (HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin)))
		{
			Button->State = PRESSED;
			Button->LastTick = HAL_GetTick();

			if(Button->ButtonPressed != NULL)
			{
				Button->ButtonPressed();
			}
		}
		else //Button released
		{
			Button->State = IDLE;
		}
	}
}

//State Pressed
static void Button_Pressed(Button_t *Button)
{
	if (GPIO_PIN_RESET == HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin))
	{
		Button->State = Release();
	}
	else if ((HAL_GetTick() - Button->LastTick) >= Button->TimerLongPress)
	{
		Button->State = REPEAT;
		Button->LastTick = HAL_GetTick();
		if (Button->ButtonLongPress != NULL)
		{
			Button->ButtonLongPress();
		}
	}
}

static void Button_Repeat(Button_t *Button)
{
	if (GPIO_PIN_RESET == HAL_GPIO_ReadPin(Button->GpioPort, Button->GpioPin))
	{
		Button->State = RELEASE;
	}
	else if ((HAL_GetTick() - Button->LastTick) >= Button->TimerRepeat)
	{
		//Repeat
		if(Button->ButtonRepeat != NULL)
		{
			Button->ButtonRepeat();
		}

		Button->LastTick = HAL_GetTick();
	}
}
static void Button_Release(Button_t *Button)
{
	if(Button->ButtonRelease != NULL)
	{
		Button->ButtonRelease();
	}
	Button->State = RELEASE;

}

void Button_SetDebounceTimer(Button_t *Button, uint32_t Milliseconds)
{
	Button->TimerDebounce = Milliseconds;
}
void Button_SetRepeatTimer(Button_t *Button, uint32_t Milliseconds)
{
	Button->TimerRepeat = Milliseconds;
}
void Button_SetLongPressTimer(Button_t *Button, uint32_t Milliseconds)
{
	Button->TimerLongPress = Milliseconds;
}



