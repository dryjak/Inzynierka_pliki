/*
 * Encoder.c
 *
 *  Created on: Oct 4, 2025
 *      Author: jakub
 */

#include "Encoder.h"

void Encoder_Init(Encoder_t *Encoder, TIM_HandleTypeDef *Tim, uint16_t PulsesPerRevolution, float SampleTime)
{
	Encoder->Tim = Tim;
	Encoder->PulsesPerRevolution = PulsesPerRevolution;
	Encoder->SampleTime = SampleTime;

	Encoder->LastCounterValue = 0;

	Encoder->TotalPulses = 0;
	Encoder->AngularVelocity = 0.0;
	Encoder->Angle = 0.0;

	__HAL_TIM_SET_COUNTER(Encoder->Tim, 0);		//reset counter value
	HAL_TIM_Encoder_Start(Encoder->Tim, TIM_CHANNEL_ALL);
}
void Encoder_Update(Encoder_t *Encoder)
{
    // Pobieramy jako uint32_t (bo tak zwraca rejestr)
    uint32_t CurrentCounterValue = __HAL_TIM_GetCounter(Encoder->Tim);

    // Obliczamy różnicę na typach 32-bit (rzutowanie na int32_t obsłuży przekręcenie licznika)
    // Np. (int32_t)(0 - 4294967295) da poprawnie 1 (lub -1 zależnie od kierunku)
    int32_t Delta = (int32_t)(CurrentCounterValue - Encoder->LastCounterValue) * -1;

    Encoder->TotalPulses += Delta;

    // WAŻNE: Dodaj zabezpieczenie przed dzieleniem przez zero
    if (Encoder->SampleTime > 0.0001f)
    {
        float InstantVelocity = ((float)Delta / (float)Encoder->PulsesPerRevolution) / Encoder->SampleTime * 60.0f;

        float a = 0.7f;
        Encoder->AngularVelocity = (Encoder->AngularVelocity * a) + (InstantVelocity * (1.0f - a));
    }

    Encoder->LastCounterValue = CurrentCounterValue;
}
