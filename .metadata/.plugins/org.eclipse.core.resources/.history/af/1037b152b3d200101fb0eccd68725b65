/*
 * SerwoSimple.c
 *
 *  Created on: Nov 6, 2025
 *      Author: dryla
 */


#include "SerwoSimple.h"
#include "tim.h"
#include <math.h>

#define PI 3.14159265

void SetAngle(uint16_t Angle, uint8_t Mode)
{
	uint16_t Tmp;

	if(Angle < AngleMin)
	{
		Angle = AngleMin;
	}
	else if(Angle > AngleMax)
	{
		Angle = AngleMax;
	}

	if(Mode)
	{
		Tmp = (PWM_Min + ((Angle - AngleMin) * STEP) / 1000);
	}
	else
	{
		Tmp = (PWM_Max - ((Angle - AngleMin) * STEP) / 1000);
	}

	__HAL_TIM_SET_COMPARE(&WhichTimer, TimerChannel,Tmp);
}

void Servo_MoveSlowly(uint16_t startAngle, uint16_t endAngle, uint8_t speedDelay)
{
    if (startAngle < endAngle)
    {
        // Ruch w górę
        for (uint16_t i = startAngle; i <= endAngle; i++)
        {
            SetAngle(i, 1);       // Ustaw mały krok
            HAL_Delay(speedDelay); // Czekaj (im dłużej, tym wolniejszy ruch)
        }
    }
    else
    {
        // Ruch w dół
        for (uint16_t i = startAngle; i >= endAngle; i--)
        {
            SetAngle(i, 1);
            HAL_Delay(speedDelay);
        }
    }
}

void Servo_Sinusoida(uint16_t centerPos, uint16_t amplitudeDeg, uint8_t speedDelay)
{
    // Przeliczamy stopnie na jednostki Twojego timera (x10)
    // Jeśli wpiszesz 30 stopni, amplituda wyniesie 300 jednostek
    float amplitudeUnits = amplitudeDeg * 10.0f;

    float x; // Zmienna "czasu" w radianach

    // Pętla od 0 do 2*PI (jeden pełny cykl fali)
    // Krok 0.05 zapewnia dobrą rozdzielczość (płynność)
    for(x = 0; x < 2 * PI; x += 0.05)
    {
        // 1. Oblicz wartość sinusa (-1.0 do 1.0)
        float sinVal = sin(x);

        // 2. Przeskaluj sinusa do wychylenia serwa
        // Wynik będzie od -300 do +300 (dla amplitudy 30 stopni)
        int16_t offset = (int16_t)(sinVal * amplitudeUnits);

        // 3. Dodaj wychylenie do punktu środkowego
        uint16_t currentAngle = centerPos + offset;

        // 4. Zadaj kąt używając Twojej funkcji
        SetAngle(currentAngle, 1);

        // 5. Czekaj (kontrola prędkości fali)
        HAL_Delay(speedDelay);
    }
}
