/*
 * Encoder.c
 *
 *  Created on: Oct 4, 2025
 *      Author: jakub
 */

#include "Encoder.h"

void Encoder_Init(Encoder_t *Encoder, TIM_HandleTypeDef *Tim, uint16_t PulsesPerRevolution, float SampleTime)
{
	Encoder->Tim = Tim;
	Encoder->PulsesPerRevolution = PulsesPerRevolution;
	Encoder->SampleTime = SampleTime;

	Encoder->LastCounterValue = 0;

	Encoder->TotalPulses = 0;
	Encoder->AngularVelocity = 0.0;
	Encoder->Angle = 0.0;

	__HAL_TIM_SET_COUNTER(Encoder->Tim, 0);		//reset counter value
	HAL_TIM_Encoder_Start(Encoder->Tim, TIM_CHANNEL_ALL);
}

void Encoder_Update(Encoder_t *Encoder)
{
	//get cutrrent value from counter
	int16_t CurrentCounterValue = (int16_t)__HAL_TIM_GetCounter(Encoder->Tim);

	int16_t Delta = CurrentCounterValue - Encoder->LastCounterValue;

	//(Impulses / ImpulsesPerRevolution) / Time * 60s
	float InstantVelocity = ((float)Delta / (float)Encoder->PulsesPerRevolution) / Encoder->SampleTime * 60.0f;

	//Low pass filter
	float a = 0.7f;
	Encoder->Velocity = (Encoder->Velocity * a) + (InstantVelocity * (1 - a));
	Encoder->LastCounterValue = CurrentCounterValue;

}
void Encoder_AngularVelocity(Encoder_t *Encoder, float *EncoderAngle, float *EncoderAngularVelocity)
{
	int16_t CurrentValue =  __HAL_TIM_GetCounter(Encoder->Tim);
	//*Sum += CurrentValue;
	(Encoder->Delta) = CurrentValue - (Encoder->LastValue);
	if((Encoder->Delta) > (Encoder->Resolution) / 2)
	{
		(Encoder->Delta) -=  (Encoder->Resolution);
	}
	else if((Encoder->Delta) < -(Encoder->Resolution) / 2)
	{
		(Encoder->Delta) += (Encoder->Resolution);
	}

	*EncoderAngle = (360.0 * (Encoder->Delta)) / (Encoder->Resolution);
	*EncoderAngularVelocity = (*EncoderAngle) / (float)(Encoder->SampleTime);
	(Encoder->LastValue) = CurrentValue;
}


